---
title: "Error Report"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dplyr)
devtools::load_all()
```


```{r data, include = FALSE}

# list of log files
paths <- init_paths(c("patient_data_raw", "product_data_raw"), delete = FALSE)
log_path <- file.path(paths$tracker_root,"output","logs")
logs <- list.files(path = log_path,
                   # probably redundant, as logs only contains log files?
                   pattern = "*.log"
                   )

# read all log files and combine into one dataframe
all_logs <- purrr::map(seq_along(logs), function(i) {

    df <- readr::read_delim(file.path(log_path, logs[[i]]),
                      delim = "\t", col_names = FALSE,
                      show_col_types = FALSE)

    df <- df %>%
        dplyr::mutate(file = logs[[i]])

    return(df)
})


# filter for relevant messages (errors and warnings)
logs_df <- bind_rows(all_logs) %>%
    dplyr::filter(X3 %in% c("WARN", "ERROR")) %>% 
    dplyr::mutate(file = stringr::str_replace(file, ".log", "")) %>% 
    dplyr::rename(type = X3,
                  issue = X5,
                  message = X6)

# sum up errors / warns per file
summary <- logs_df %>% 
    dplyr::count(file, type)


details <- logs_df %>% 
    dplyr::select(type, file, issue, message) %>% 
    dplyr::distinct() %>% 
    dplyr::arrange(type, file)

```


Last compiled on `r format(Sys.Date(), '%d %B, %Y')`

### Summary

#### Files

* `r length(all_logs)` files processed

* `r length(all_logs) - nrow(distinct(logs_df, file))` files sucessfully
processed (without errors or warnings)

* `r sum(summary$type == "ERROR")` files with errors

* `r sum(summary$type == "WARN")` files with warnings

<br>

#### Errors and warnings

* Total errors: `r sum(details$type == "ERROR")`

* Total warnings: `r sum(details$type == "WARN")`

<br>

### List of errors and warnings

`r knitr::kable(details)`
